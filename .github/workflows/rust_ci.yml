name: Rust Checks

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ESP32 firmware build
  build-esp32:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Remove rust-toolchain.toml (ESP32C3 ayarını kaldır)
        run: |
          rm -f rust-toolchain.toml || true
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Install ESP IDF
        run: |
          curl -LO https://github.com/esp-rs/rust-build/releases/download/v1.2.0/install-rust-toolchain.sh
          chmod +x install-rust-toolchain.sh
          ./install-rust-toolchain.sh
          source "$HOME/export-esp.sh"
      
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Build Web UI
        run: |
          cd vue-ui
          npm install
          npm run build
          cd ..
      
      - name: Create custom Cargo.toml for ESP32
        run: |
          # Yedek al
          cp Cargo.toml Cargo.toml.bak
          
          # Yeni Cargo.toml oluştur
          cat > Cargo.toml << 'EOF'
          [package]
          name = "evil-apple-juice-esp32-rs"
          version = "0.1.0"
          edition = "2021"
          
          [dependencies]
          log = "0.4"
          esp-idf-svc = { version = "0.47", features = ["alloc"] }
          esp32-nimble = "0.11"
          esp-idf-hal = "0.42"
          embassy-futures = "0.1"
          
          # HTTP server'ları geçici olarak kaldır
          # esp-async-tcp = { git = "https://github.com/lz1998/esp-async-tcp.git", branch = "main" }
          # esp-async-http-server = { git = "https://github.com/lz1998/esp-async-http-server.git" }
          
          [build-dependencies]
          embuild = "0.31"
          
          [package.metadata.esp-idf]
          chip = "esp32"
          EOF
          
          echo "Yeni Cargo.toml oluşturuldu"
      
      - name: Build Firmware
        run: |
          source "$HOME/export-esp.sh"
          cargo build --release
      
      - name: Restore original Cargo.toml
        run: |
          mv Cargo.toml.bak Cargo.toml || true
      
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: evil-apple-juice-firmware
          path: target/xtensa-esp32-espidf/release/*.bin
