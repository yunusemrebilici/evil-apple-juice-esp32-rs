name: Build ESP32 Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install ESP Rust Toolchain
        run: |
          # Önce curl'ü yükle (genelde var ama garanti olsun)
          sudo apt-get update
          sudo apt-get install -y curl
          
          # Rust'ı kur
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source ~/.cargo/env
          
          # ESP toolchain'i kur
          cargo install espup
          espup install
          source ~/export-esp.sh
      
      - name: Install Node.js for Web UI
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Build Web UI
        run: |
          cd vue-ui
          npm install
          npm run build
          cd ..
      
      - name: Configure for ESP32 and Build
        run: |
          source ~/.cargo/env
          source ~/export-esp.sh
          
          # Chip konfigürasyonunu esp32 yap
          echo '[package.metadata.esp-idf]' >> Cargo.toml
          echo 'chip = "esp32"' >> Cargo.toml
          
          # ESP32-NimBLE konfigürasyonu
          echo 'esp32-nimble = "0.11"' >> Cargo.toml.tmp
          
          # Release build
          cargo build --release
      
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: evil-apple-juice-firmware
          path: target/xtensa-esp32-espidf/release/*.bin
